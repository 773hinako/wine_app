# 📷 写真機能の仕様

## 実装済み機能

### 1. Androidでのカメラ起動対応

**問題**: Androidデバイスで「写真を選択」しかできず、「カメラで撮影」を選択できない

**解決策**: `input[type="file"]` に `capture="environment"` 属性を追加

```html
<input type="file" id="photo-input" accept="image/*" capture="environment">
```

**効果**:
- ✅ Androidで「カメラで撮影」と「ギャラリーから選択」の両方が表示される
- ✅ `capture="environment"` は背面カメラを優先的に使用
- ✅ iOSでも問題なく動作

---

### 2. 端末の写真アプリへの自動保存

**機能**: アプリ内で写真を撮影/選択した際、端末の写真アプリ（ギャラリー、写真など）にも自動保存

**実装方法**:

#### モバイルデバイス
- ダウンロードリンクを自動生成・クリックして端末に保存
- ファイル名: `wine_photo_YYYY-MM-DD-HHMMSS.jpg`
- 保存先: 端末の「ダウンロード」フォルダ（通常は写真アプリから参照可能）

#### デスクトップブラウザ
- 自動保存をスキップ（ユーザーの意図しない保存を防ぐ）
- アプリ内（IndexedDB）には保存される

**コード概要**:

```javascript
// handlePhotoSelect() 内で呼び出し
await savePhotoToDevice(file);

// 端末保存の実装
async function savePhotoToDevice(file) {
    // デスクトップブラウザではスキップ
    if ('showSaveFilePicker' in window) {
        return;
    }
    
    // モバイルデバイスでダウンロード
    await downloadImageToDevice(file);
}
```

---

## 動作フロー

```
ユーザーが「📷 写真を撮影/選択」ボタンをクリック
    ↓
【Android】
カメラで撮影 / ギャラリーから選択 の選択肢が表示
    ↓
写真を選択・撮影
    ↓
1. 画像を圧縮（1200px、品質85%）
2. サムネイル生成（400px、品質80%）
3. プレビュー表示
4. 端末の写真アプリに自動保存 ← NEW!
    ↓
「画像を追加しました」トースト表示
```

---

## ブラウザ対応

| ブラウザ | カメラ起動 | 写真選択 | 端末保存 |
|---------|-----------|---------|---------|
| Chrome (Android) | ✅ | ✅ | ✅ |
| Safari (iOS) | ✅ | ✅ | ✅ |
| Chrome (Desktop) | - | ✅ | ❌ (スキップ) |
| Edge (Desktop) | - | ✅ | ❌ (スキップ) |

**注意**:
- デスクトップブラウザでは通常、カメラアクセスはWebRTC API経由で行うため、`capture` 属性は機能しません
- 端末保存はモバイルデバイスでのみ有効化されます

---

## エラーハンドリング

端末保存に失敗した場合でも、アプリ内（IndexedDB）への保存は続行されます。

```javascript
catch (error) {
    // エラーログのみ出力、処理は継続
    console.warn('写真の端末保存に失敗しましたが、アプリ内には保存されています:', error);
}
```

---

## ファイルサイズとパフォーマンス

### 圧縮設定
- **詳細表示用**: 最大1200px、品質85% → 約100-300KB
- **サムネイル**: 最大400px、品質80% → 約20-50KB

### メリット
- ✅ IndexedDBの容量節約
- ✅ 高速なリスト表示
- ✅ データエクスポートのファイルサイズ削減

---

## ユーザーへの案内

アプリ内の説明文:
> カメラで撮影、またはギャラリーから既存の写真を選択できます

**今後の改善案**:
- 端末保存の成功/失敗を明示的に通知
- 端末保存のON/OFF設定を追加
- 保存先フォルダのカスタマイズ（File System Access API使用）

---

## セキュリティとプライバシー

- ✅ ユーザーが明示的に選択した写真のみ保存
- ✅ ファイルアクセス権限はブラウザが管理
- ✅ データはローカル保存のみ（サーバー送信なし）
- ✅ HTTPS環境で動作（PWA要件）

---

最終更新: 2025年10月26日
